/*!
 * Copyright (c) 2012 Kinvey, Inc. All rights reserved.
 *
 * Licensed to Kinvey, Inc. under one or more contributor
 * license agreements.  See the NOTICE file distributed with
 * this work for additional information regarding copyright
 * ownership.  Kinvey, Inc. licenses this file to you under the
 * Apache License, Version 2.0 (the "License"); you may not
 * use this file except in compliance with the License.  You
 * may obtain a copy of the License at
 *
 *         http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */
(function(undefined){var t=this,n;"undefined"!=typeof exports?n=exports:n=t.Kinvey={};var r=Object.defineProperty(function(){},"extend",{value:function(e,t){var n=e&&e.hasOwnProperty("constructor")?e.constructor:this,r=function(){n.apply(this,arguments)};r.prototype=function(e,t){return Object.getOwnPropertyNames(t).forEach(function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}),e}(Object.create(this.prototype),e||{});if(t)for(var i in t)t.hasOwnProperty(i)&&(r[i]=t[i]);return Object.defineProperty(r,"extend",Object.getOwnPropertyDescriptor(this,"extend")),r}}),i=function(e,t){return t||(t=function(){}),t.bind?t.bind(e):function(){return t.apply(e,arguments)}},s=function(){var e={};return Array.prototype.slice.call(arguments,0).forEach(function(t){for(var n in t)e[n]=t[n]}),e},o={get:function(e){var t=localStorage.getItem(e);return t?JSON.parse(t):null},set:function(e,t){localStorage.setItem(e,JSON.stringify(t))},remove:function(e){localStorage.removeItem(e)}},u=function(){var e=function(e){return btoa(e)},t=function(e){if(null!=n.masterSecret)return"Basic "+this._base64(n.appKey+":"+n.masterSecret);var t=n.getCurrentUser();return!e&&null!==t?"Kinvey "+t.getToken():"Basic "+this._base64(n.appKey+":"+n.appSecret)},r=function(){var e=navigator.userAgent.toLowerCase(),t=/(chrome)\/([\w]+)/,n=/(safari)\/([\w.]+)/,r=/(firefox)\/([\w.]+)/,i=/(opera)(?:.*version)?[ \/]([\w.]+)/,s=/(msie) ([\w.]+)/i,o=t.exec(e)||n.exec(e)||r.exec(e)||i.exec(e)||s.exec(e)||[];return["js-appcloud/0.9.11",o[1]||navigator.appName,o[2]||0,0].map(function(e){return e.toString().toLowerCase().replace(" ","_")}).join(" ")},o=function(e,t,r,o){o||(o={}),"undefined"!=typeof o.timeout||(o.timeout=this.options.timeout),o.success||(o.success=this.options.success),o.error||(o.error=this.options.error);if(null===n.getCurrentUser()&&n.Store.AppData.USER_API!==this.api&&null==n.masterSecret&&!o.appc)return n.User.create({},s(o,{success:i(this,function(){this._send(e,t,r,o)})}));t=n.HOST+t;var u={Accept:"application/json, text/javascript",Authorization:this._getAuth(o.appc),"X-Kinvey-API-Version":n.API_VERSION,"X-Kinvey-Device-Information":this._getDeviceInfo()};r&&(u["Content-Type"]="application/json; charset=utf-8"),"GET"===e&&"undefined"!=typeof window&&window.location&&(u["X-Kinvey-Origin"]=window.location.protocol+"//"+window.location.host),this._xhr(e,t,r,s(o,{headers:u,success:function(e,t){e=e?JSON.parse(e):null,o.success(e,t)},error:function(e,t){try{e=JSON.parse(e)}catch(r){var i={abort:"The request was aborted",error:"The request failed",timeout:"The request timed out"};e={error:n.Error.REQUEST_FAILED,description:i[e]||i.error,debug:""}}o.error(e,t)}}))},u=function(e,t,n,r){r||(r={}),r.headers||(r.headers={}),"undefined"!=typeof r.timeout||(r.timeout=this.options.timeout),r.success||(r.success=this.options.success),r.error||(r.error=this.options.error);var i=new XMLHttpRequest;i.open(e,t),i.timeout=r.timeout;for(var s in r.headers)r.headers.hasOwnProperty(s)&&i.setRequestHeader(s,r.headers[s]);i.onload=function(){2===parseInt(this.status/100,10)||304===this.status?r.success(this.responseText,{network:!0}):r.error(this.responseText,{network:!0})},i.onabort=i.onerror=i.ontimeout=function(e){r.error(e.type,{network:!0})},i.send(n)};return function(){return this._base64=e,this._getAuth=t,this._getDeviceInfo=r,this._send=o,this._xhr=u,this}}(),a=null;n.API_VERSION=2,n.HOST="https://baas.kinvey.com",n.SDK_VERSION="0.9.11",n.getCurrentUser=function(){return a},n.init=function(e){e||(e={});if(null==e.appKey)throw new Error("appKey must be defined");if(null==e.appSecret&&null==e.masterSecret)throw new Error("appSecret or masterSecret must be defined");n.appKey=e.appKey,n.appSecret=e.appSecret||null,n.masterSecret=e.masterSecret||null,n.User._restore(),e.sync&&n.Sync&&n.Sync.application()},n.ping=function(e){(new n.Store.AppData(null)).query(null,e)},n.setCurrentUser=function(e){a=e},n.Error={DATABASE_ERROR:"DatabaseError",NO_NETWORK:"NoNetwork",REQUEST_FAILED:"RequestFailed",RESPONSE_PROBLEM:"ResponseProblem",ENTITY_NOT_FOUND:"EntityNotFound",COLLECTION_NOT_FOUND:"CollectionNotFound",APP_NOT_FOUND:"AppNotFound",USER_NOT_FOUND:"UserNotFound",BLOB_NOT_FOUND:"BlobNotFound",INVALID_CREDENTIALS:"InvalidCredentials",KINVEY_INTERNAL_ERROR_RETRY:"KinveyInternalErrorRetry",KINVEY_INTERNAL_ERROR_STOP:"KinveyInternalErrorStop",USER_ALREADY_EXISTS:"UserAlreadyExists",DUPLICATE_END_USERS:"DuplicateEndUsers",INSUFFICIENT_CREDENTIALS:"InsufficientCredentials",WRITES_TO_COLLECTION_DISALLOWED:"WritesToCollectionDisallowed",INDIRECT_COLLECTION_ACCESS_DISALLOWED:"IndirectCollectionAccessDisallowed",APP_PROBLEM:"AppProblem",PARAMETER_VALUE_OUT_OF_RANGE:"ParameterValueOutOfRange",CORS_DISABLED:"CORSDisabled",INVALID_QUERY_SYNTAX:"InvalidQuerySyntax",MISSING_QUERY:"MissingQuery",JSON_PARSE_ERROR:"JSONParseError",MISSING_REQUEST_HEADER:"MissingRequestHeader",INCOMPLETE_REQUEST_BODY:"IncompleteRequestBody",MISSING_REQUEST_PARAMETER:"MissingRequestParameter",INVALID_IDENTIFIER:"InvalidIdentifier",BAD_REQUEST:"BadRequest",FEATURE_UNAVAILABLE:"FeatureUnavailable",API_VERSION_NOT_IMPLEMENTED:"APIVersionNotImplemented",API_VERSION_NOT_AVAILABLE:"APIVersionNotAvailable",INPUT_VALIDATION_FAILED:"InputValidationFailed",BL_RUNTIME_ERROR:"BLRuntimeError",BL_SYNTAX_ERROR:"BLSyntaxError",BL_TIMEOUT_ERROR:"BLTimeoutError",BL_VIOLATION_ERROR:"BLViolationError",BL_INTERNAL_ERROR:"BLInternalError",STALE_REQUEST:"StaleRequest"},n.Entity=r.extend({ATTR_ID:"_id",map:{},constructor:function(e,t,r){if(null==t)throw new Error("Collection must not be null");this.collection=t,this.metadata=null,r||(r={}),this.store=n.Store.factory(r.store,this.collection,r.options),r.map&&(this.map=r.map),this.attr=e?this._parseAttr(e):{},this._pending=!1},destroy:function(e){e||(e={}),this.store.remove(this.toJSON(),s(e,{success:i(this,function(t,n){e.success&&e.success(this,n)})}))},get:function(e){if(null==e)throw new Error("Key must not be null");var t=this.attr[e];return null!=t?t:null},getId:function(){return this.get(this.ATTR_ID)},getMetadata:function(){return this.metadata||(this.metadata=new n.Metadata(this.attr)),this.metadata},isNew:function(){return null===this.getId()},load:function(e,t){if(null==e)throw new Error("Id must not be null");t||(t={}),this.store.query(e,s(t,{success:i(this,function(e,n){this.attr=this._parseAttr(e),this.metadata=null,t.success&&t.success(this,n)})}))},save:function(e){e||(e={});if(this._pending&&e._ref){this._pending=!1,e.error({error:n.Error.BAD_REQUEST,message:"Circular reference detected, aborting save",debug:""},{});return}this._pending=!0,this._saveAttr(this.attr,{success:i(this,function(t){this.store.save(this.toJSON(),s(e,{success:i(this,function(n,r){this._pending=!1,this.attr=s(this._parseAttr(n),t),this.metadata=null,e.success&&e.success(this,r)}),error:i(this,function(t,n){this._pending=!1,e.error&&e.error(t,n)})}))}),error:i(this,function(t,n){this._pending=!1,e.error&&e.error(t,n)}),_ref:!0})},set:function(e,t){if(null==e)throw new Error("Key must not be null");this.attr[e]=this._parse(e,t)},setId:function(e){if(null==e)throw new Error("Id must not be null");this.set(this.ATTR_ID,e)},setMetadata:function(e){if(!(!e||e instanceof n.Metadata))throw new Error("Metadata must be an instanceof Kinvey.Metadata");this.metadata=e||null},toJSON:function(e){var t=this._flattenAttr(this.attr);return this.metadata&&(t._acl=this.metadata.toJSON()._acl),t},unset:function(e){delete this.attr[e]},_flatten:function(e){return e instanceof Object&&(e instanceof n.Entity?e={_type:"KinveyRef",_collection:e.collection,_id:e.getId()}:e instanceof Array?e=e.map(i(this,function(e){return this._flatten(e)})):e=this._flattenAttr(e)),e},_flattenAttr:function(e){var t={};return Object.keys(e).forEach(i(this,function(n){t[n]=this._flatten(e[n])})),t},_parse:function(e,t){if(t instanceof Object&&!(t instanceof n.Entity))if("KinveyRef"===t._type){if(t._obj){var r=this.map[e]||n.Entity,s={store:this.store.type,options:this.store.options};t=new r(t._obj,t._collection,s)}}else t instanceof Array?t=t.map(i(this,function(t){return this._parse(e,t)})):t=this._parseAttr(t,e);return t},_parseAttr:function(e,t){var n=s(e);return Object.keys(e).forEach(i(this,function(r){n[r]=this._parse((t?t+".":"")+r,e[r])})),n},_save:function(e,t){if(e instanceof Object){if(e instanceof n.Entity)return e.getMetadata().hasWritePermissions()?e.save(t):t.success(e);if(e instanceof Array){var r=0,o=i(this,function(){var n=e[r];n?this._save(n,s(t,{success:function(t){e[r++]=t,o()}})):t.success(e)});return o()}return this._saveAttr(e,t)}t.success(e)},_saveAttr:function(e,t){var n=Object.keys(e),r=0,o=i(this,function(){var i=n[r++];i?this._save(e[i],s(t,{success:function(t){e[i]=t,o()}})):t.success(e)});o()}}),n.Collection=r.extend({list:[],entity:n.Entity,constructor:function(e,t){if(null==e)throw new Error("Name must not be null");this.name=e,t||(t={}),this.setQuery(t.query||new n.Query),this.store=n.Store.factory(t.store,this.name,t.options)},aggregate:function(e,t){if(!(e instanceof n.Aggregation))throw new Error("Aggregation must be an instanceof Kinvey.Aggregation");e.setQuery(this.query),this.store.aggregate(e.toJSON(),t)},clear:function(e){e||(e={}),this.store.removeWithQuery(this.query.toJSON(),s(e,{success:i(this,function(t,n){this.list=[],e.success&&e.success(n)})}))},count:function(e){e||(e={});var t=new n.Aggregation;t.setInitial({count:0}),t.setReduce(function(e,t){t.count+=1}),t.setQuery(this.query),this.store.aggregate(t.toJSON(),s(e,{success:function(t,n){var r=t[0]?t[0].count:0;e.success&&e.success(r,n)}}))},fetch:function(e){e||(e={}),this.store.queryWithQuery(this.query.toJSON(),s(e,{success:i(this,function(t,n){this.list=[],t.forEach(i(this,function(e){var t={store:this.store.name,options:this.store.options};this.list.push(new this.entity(e,this.name,t))})),e.success&&e.success(this.list,n)})}))},setQuery:function(e){if(!(!e||e instanceof n.Query))throw new Error("Query must be an instanceof Kinvey.Query");this.query=e||new n.Query}});var f=function(){return"Kinvey."+n.appKey};n.User=n.Entity.extend({ATTR_USERNAME:"username",ATTR_PASSWORD:"password",token:null,constructor:function(e){n.Entity.prototype.constructor.call(this,e,"user")},destroy:function(e){e||(e={}),n.Entity.prototype.destroy.call(this,s(e,{success:i(this,function(t,n){this._logout(),e.success&&e.success(this,n)})}))},getIdentity:function(){return this.get("_socialIdentity")},getToken:function(){return this.token},getUsername:function(){return this.get(this.ATTR_USERNAME)},isVerified:function(){var e=this.getMetadata().kmd.emailVerification;return e?"confirmed"===e.status:!1},login:function(e,t,n){this._doLogin({username:e,password:t},n||{})},loginWithFacebook:function(e,t,r){t||(t={}),t._socialIdentity={facebook:{access_token:e}},r||(r={}),this._doLogin(t,s(r,{error:i(this,function(e,i){if(n.Error.USER_NOT_FOUND===e.error)return this.attr=t,n.User.create(t,s(r,{_target:this}));r.error&&r.error(e,i)})}))},logout:function(e){e||(e={});if(!this.isLoggedIn){e.success&&e.success({});return}this.store.logout({},s(e,{success:i(this,function(t,n){this._logout(),e.success&&e.success(n)})}))},save:function(e){e||(e={});if(!this.isLoggedIn){e.error&&e.error({code:n.Error.BAD_REQUEST,description:"This operation is not allowed",debug:"Cannot save a user which is not logged in."},{});return}n.Entity.prototype.save.call(this,s(e,{success:i(this,function(t,n){this._saveToDisk(),e.success&&e.success(this,n)})}))},_deleteFromDisk:function(){o.remove(f())},_doLogin:function(e,t){var r=n.getCurrentUser();if(null!==r){r.logout(s(t,{success:i(this,function(){this._doLogin(e,t)})}));return}this.store.login(e,s(t,{success:i(this,function(e,n){var r=e._kmd.authtoken;delete e._kmd.authtoken,this.attr=this._parseAttr(e),this._login(r),t.success&&t.success(this,n)})}))},_login:function(e){null==n.masterSecret&&(n.setCurrentUser(this),this.isLoggedIn=!0,this.token=e,this._saveToDisk())},_logout:function(){null==n.masterSecret&&(n.setCurrentUser(null),this.isLoggedIn=!1,this.token=null,this._deleteFromDisk())},_saveToDisk:function(){o.set(f(),{token:this.token,user:this.toJSON()})}},{create:function(e,t){t||(t={});var r=n.getCurrentUser();if(null!==r){r.logout(s(t,{success:function(){n.User.create(e,t)}}));return}var o=t._target||new n.User(e);return n.Entity.prototype.save.call(o,s(t,{success:i(o,function(e,n){var r=this.attr._kmd.authtoken;delete this.attr._kmd.authtoken,this._login(r),t.success&&t.success(this,n)})})),o},init:function(e){e||(e={});var t=n.getCurrentUser();return null!==t?(e.success&&e.success(t,{}),t):n.User.create({},e)},resetPassword:function(e,t){var r=new n.Store.Rpc;r.resetPassword(e,t)},verifyEmail:function(e,t){var r=new n.Store.Rpc;r.verifyEmail(e,t)},_restore:function(){if(null!==n.getCurrentUser())return;var e=o.get(f());null!==e&&null!=e.token&&null!=e.user&&(new n.User(e.user))._login(e.token)}}),n.UserCollection=n.Collection.extend({entity:n.User,constructor:function(e){n.Collection.prototype.constructor.call(this,"user",e)},clear:function(e){e&&e.error&&e.error({code:n.Error.BAD_REQUEST,description:"This operation is not allowed",debug:""})}}),n.Metadata=r.extend({constructor:function(e){e||(e={}),this.acl=e._acl||{},this.kmd=e._kmd||{}},addReader:function(e){this.acl.r||(this.acl.r=[]),-1===this.acl.r.indexOf(e)&&this.acl.r.push(e)},addWriter:function(e){this.acl.w||(this.acl.w=[]),-1===this.acl.w.indexOf(e)&&this.acl.w.push(e)},creator:function(){return this.acl.creator||null},getReaders:function(){return this.acl.r||[]},getWriters:function(){return this.acl.w||[]},isOwner:function(){var e=this.acl.creator,t=n.getCurrentUser();return e?!!t&&e===t.getId():!0},lastModified:function(){return this.kmd.lmt||null},hasWritePermissions:function(){if(this.isOwner()||this.isGloballyWritable())return!0;var e=n.getCurrentUser();return e&&this.acl.w?-1!==this.acl.w.indexOf(e.getId()):!1},isGloballyReadable:function(){return!!this.acl.gr},isGloballyWritable:function(){return!!this.acl.gw},removeReader:function(e){if(this.acl.r){var t=this.acl.r.indexOf(e);-1!==t&&this.acl.r.splice(t,1)}},removeWriter:function(e){if(this.acl.w){var t=this.acl.w.indexOf(e);-1!==t&&this.acl.w.splice(t,1)}},setGloballyReadable:function(e){this.acl.gr=!!e},setGloballyWritable:function(e){this.acl.gw=!!e},toJSON:function(){return{_acl:this.acl,_kmd:this.kmd}}}),n.Query=r.extend({currentKey:null,constructor:function(e){this.builder=e||n.Query.factory()},all:function(e){if(e instanceof Array)return this._set(n.Query.ALL,e),this;throw new Error("Argument must be of type Array")},and:function(e){return this._set(n.Query.AND,e.builder,!0),this},equal:function(e){return this._set(n.Query.EQUAL,e),this},exist:function(e){return e="undefined"!=typeof e?!!e:!0,this._set(n.Query.EXIST,e),this},greaterThan:function(e){return this._set(n.Query.GREATER_THAN,e),this},greaterThanEqual:function(e){return this._set(n.Query.GREATER_THAN_EQUAL,e),this},in_:function(e){if(e instanceof Array)return this._set(n.Query.IN,e),this;throw new Error("Argument must be of type Array")},lessThan:function(e){return this._set(n.Query.LESS_THAN,e),this},lessThanEqual:function(e){return this._set(n.Query.LESS_THAN_EQUAL,e),this},nearSphere:function(e,t){if(e instanceof Array&&2===e.length)return this._set(n.Query.NEAR_SPHERE,{point:e,maxDistance:"undefined"!=typeof t?t:null}),this;throw new Error("Point must be of type Array[lng, lat]")},notEqual:function(e){return this._set(n.Query.NOT_EQUAL,e),this},notIn:function(e){if(e instanceof Array)return this._set(n.Query.NOT_IN,e),this;throw new Error("Argument must be of type Array")},on:function(e){return this.currentKey=e,this},or:function(e){return this._set(n.Query.OR,e.builder,!0),this},regex:function(e){return this._set(n.Query.REGEX,e),this},reset:function(){return this.builder.reset(),this},setLimit:function(e){return this.builder.setLimit(e),this},setSkip:function(e){return this.builder.setSkip(e),this},size:function(e){return this._set(n.Query.SIZE,e),this},sort:function(e){return null!==e&&(e=e||n.Query.ASC),this.builder.setSort(this.currentKey,e),this},toJSON:function(){return this.builder.toJSON()},withinBox:function(e){if(e instanceof Array&&2===e.length)return this._set(n.Query.WITHIN_BOX,e),this;throw new Error("Points must be of type Array[[lng, lat], [lng, lat]]")},withinCenterSphere:function(e,t){if(e instanceof Array&&2===e.length)return this._set(n.Query.WITHIN_CENTER_SPHERE,{center:e,radius:t}),this;throw new Error("Point must be of type Array[lng, lat]")},withinPolygon:function(e){if(e instanceof Array)return this._set(n.Query.WITHIN_POLYGON,e),this;throw new Error("Points must be of type Array[[lng, lat], ...]")},_set:function(e,t,n){if(null===this.currentKey&&!n)throw new Error("Key under condition must not be null");this.builder.addCondition(this.currentKey,e,t)}},{EQUAL:16,EXIST:17,LESS_THAN:18,LESS_THAN_EQUAL:19,GREATER_THAN:20,GREATER_THAN_EQUAL:21,NOT_EQUAL:22,REGEX:23,NEAR_SPHERE:1024,WITHIN_BOX:1025,WITHIN_CENTER_SPHERE:1026,WITHIN_POLYGON:1027,MAX_DISTANCE:1028,IN:2048,NOT_IN:2049,AND:4096,OR:4097,ALL:8192,SIZE:8193,ASC:16384,DESC:16385,factory:function(){return new n.Query.MongoBuilder}}),n.Query.MongoBuilder=r.extend({limit:null,skip:null,sort:null,query:null,constructor:function(){},addCondition:function(e,t,r){switch(t){case n.Query.EQUAL:this.query||(this.query={}),this.query[e]=r;break;case n.Query.EXIST:this._set(e,{$exists:r});break;case n.Query.LESS_THAN:this._set(e,{$lt:r});break;case n.Query.LESS_THAN_EQUAL:this._set(e,{$lte:r});break;case n.Query.GREATER_THAN:this._set(e,{$gt:r});break;case n.Query.GREATER_THAN_EQUAL:this._set(e,{$gte:r});break;case n.Query.NOT_EQUAL:this._set(e,{$ne:r});break;case n.Query.REGEX:var i=new RegExp(r),s=(i.global?"g":"")+(i.ignoreCase?"i":"")+(i.multiline?"m":"");this._set(e,{$regex:i.source,$options:s});break;case n.Query.NEAR_SPHERE:var o={$nearSphere:r.point};r.maxDistance&&(o.$maxDistance=r.maxDistance),this._set(e,o);break;case n.Query.WITHIN_BOX:this._set(e,{$within:{$box:r}});break;case n.Query.WITHIN_CENTER_SPHERE:this._set(e,{$within:{$centerSphere:[r.center,r.radius]}});break;case n.Query.WITHIN_POLYGON:this._set(e,{$within:{$polygon:r}});break;case n.Query.IN:this._set(e,{$in:r});break;case n.Query.NOT_IN:this._set(e,{$nin:r});break;case n.Query.AND:if(!(r instanceof n.Query.MongoBuilder))throw new Error("Query must be of type Kinvey.Query.Mongobuilder");this.query={$and:[this.query||{},r.query||{}]};break;case n.Query.OR:if(!(r instanceof n.Query.MongoBuilder))throw new Error("Query must be of type Kinvey.Query.Mongobuilder");this.query={$or:[this.query||{},r.query||{}]};break;case n.Query.ALL:this._set(e,{$all:r});break;case n.Query.SIZE:this._set(e,{$size:r});break;default:throw new Error("Condition "+t+" is not supported")}},reset:function(){this.query=null},setLimit:function(e){this.limit=e},setSkip:function(e){this.skip=e},setSort:function(e,t){if(null==t){this.sort=null;return}var r=n.Query.ASC===t?1:-1;this.sort={},this.sort[e]=r},toJSON:function(){var e={};return this.limit&&(e.limit=this.limit),this.skip&&(e.skip=this.skip),this.sort&&(e.sort=this.sort),this.query&&(e.query=this.query),e},_set:function(e,t){this.query||(this.query={}),this.query[e]instanceof Object||(this.query[e]={});for(var n in t)t.hasOwnProperty(n)&&(this.query[e][n]=t[n])}}),n.Aggregation=r.extend({constructor:function(e){this.builder=e||n.Aggregation.factory()},on:function(e){return this.builder.on(e),this},setFinalize:function(e){this.builder.setFinalize(e)},setInitial:function(e){return this.builder.setInitial(e),this},setQuery:function(e){if(!e||e instanceof n.Query)return this.builder.setQuery(e),this;throw new Error("Query must be an instanceof Kinvey.Query")},setReduce:function(e){return this.builder.setReduce(e),this},toJSON:function(){return this.builder.toJSON()}},{factory:function(){return new n.Aggregation.MongoBuilder}}),n.Aggregation.MongoBuilder=r.extend({finalize:function(){},initial:{count:0},keys:null,reduce:function(e,t){t.count++},query:null,constructor:function(){this.keys={}},on:function(e){this.keys[e]=!0},setFinalize:function(e){this.finalize=e},setInitial:function(e){this.initial=e},setQuery:function(e){return this.query=e,this},setReduce:function(e){this.reduce=e},toJSON:function(){var e={finalize:this.finalize.toString(),initial:this.initial,key:this.keys,reduce:this.reduce.toString()},t=this.query&&this.query.toJSON().query;return t&&(e.condition=t),e}}),n.Store={APPDATA:"appdata",CACHED:"cached",OFFLINE:"offline",factory:function(e,t,r){return n.Store.CACHED===e?new n.Store.Cached(t,r):n.Store.OFFLINE===e?new n.Store.Offline(t,r):new n.Store.AppData(t,r)}},n.Store.Rpc=r.extend({options:{timeout:1e4,success:function(){},error:function(){}},constructor:function(e){e&&this.configure(e)},configure:function(e){"undefined"!=typeof e.timeout&&(this.options.timeout=e.timeout),e.success&&(this.options.success=e.success),e.error&&(this.options.error=e.error)},resetPassword:function(e,t){var n=this._getUrl([e,"user-password-reset-initiate"]);this._send("POST",n,null,s(t,{appc:!0}))},verifyEmail:function(e,t){var n=this._getUrl([e,"user-email-verification-initiate"]);this._send("POST",n,null,s(t,{appc:!0}))},_getUrl:function(e){var t="/rpc/"+n.appKey;return e.forEach(function(e){t+="/"+e}),t+"?_="+(new Date).getTime()}}),u.call(n.Store.Rpc.prototype),n.Store.AppData=r.extend({name:n.Store.APPDATA,options:{timeout:1e4,success:function(){},error:function(){}},constructor:function(e,t){this.api=n.Store.AppData.USER_API===e?n.Store.AppData.USER_API:n.Store.AppData.APPDATA_API,this.collection=e,t&&this.configure(t)},aggregate:function(e,t){var n=this._getUrl({id:"_group"});this._send("POST",n,JSON.stringify(e),t)},configure:function(e){"undefined"!=typeof e.timeout&&(this.options.timeout=e.timeout),e.success&&(this.options.success=e.success),e.error&&(this.options.error=e.error)},login:function(e,t){var n=this._getUrl({id:"login"});this._send("POST",n,JSON.stringify(e),t)},logout:function(e,t){var n=this._getUrl({id:"_logout"});this._send("POST",n,null,t)},query:function(e,t){t||(t={}),null===e&&(t.appc=!0);var n=this._getUrl({id:e,resolve:t.resolve});this._send("GET",n,null,t)},queryWithQuery:function(e,t){t||(t={});var n=this._getUrl({query:e,resolve:t.resolve});this._send("GET",n,null,t)},remove:function(e,t){var n=this._getUrl({id:e._id});this._send("DELETE",n,null,t)},removeWithQuery:function(e,t){var n=this._getUrl({query:e});this._send("DELETE",n,null,t)},save:function(e,t){var n=e._id?"PUT":"POST",r=this._getUrl({id:e._id});this._send(n,r,JSON.stringify(e),t)},_encode:function(e){return e instanceof Object&&(e=JSON.stringify(e)),encodeURIComponent(e)},_getUrl:function(e){var t="/"+this.api+"/"+n.appKey+"/";n.Store.AppData.APPDATA_API===this.api&&null!=this.collection&&(t+=this.collection+"/"),e.id&&(t+=e.id);var r=[];return null!=e.query&&(r.push("query="+this._encode(e.query.query||{})),e.query.limit&&r.push("limit="+this._encode(e.query.limit)),e.query.skip&&r.push("skip="+this._encode(e.query.skip)),e.query.sort&&r.push("sort="+this._encode(e.query.sort))),e.resolve&&r.push("resolve="+e.resolve.join(",")),r.push("_="+(new Date).getTime()),t+"?"+r.join("&")}},{APPDATA_API:"appdata",USER_API:"user"}),u.call(n.Store.AppData.prototype);var l=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB,c=window.IDBTransaction||window.webkitIDBTransaction||{},h=r.extend({constructor:function(e){this.name="Kinvey."+n.appKey,this.collection=e},aggregate:function(e,t){t=this._options(t),this._transaction(h.AGGREGATION_STORE,h.READ_ONLY,i(this,function(r){var i=this._getKey(e),s=r.objectStore(h.AGGREGATION_STORE).get(i);r.oncomplete=function(){var e=s.result;e?t.success(e.response,{cached:!0}):t.error(n.Error.DATABASE_ERROR,"Aggregation is not in database.")},r.onabort=r.onerror=function(){t.error(n.Error.DATABASE_ERROR,r.error||"Failed to execute transaction.")}}),t.error)},query:function(e,t){t=this._options(t),this._transaction(this.collection,h.READ_ONLY,i(this,function(r){var s=r.objectStore(this.collection).get(e);r.oncomplete=i(this,function(){var e=s.result;if(e){if(t.resolve&&t.resolve.length)return this._resolve(e,t.resolve,function(){t.success(e,{cached:!0})});t.success(e,{cached:!0})}else t.error(n.Error.ENTITY_NOT_FOUND,"This entity could not be found.")}),r.onabort=r.onerror=function(){t.error(n.Error.DATABASE_ERROR,r.error||"Failed to execute transaction.")}}),t.error)},queryWithQuery:function(e,t){t=this._options(t),this._transaction([this.collection,h.QUERY_STORE],h.READ_ONLY,i(this,function(r){var s=[],o=this._getKey(e),u=r.objectStore(h.QUERY_STORE).get(o);u.onsuccess=i(this,function(){var e=u.result;if(e){var t=r.objectStore(this.collection);e.response.forEach(function(e){var n=t.get(e);n.onsuccess=function(){n.result&&s.push(n.result)}})}}),r.oncomplete=i(this,function(){if(u.result)if(t.resolve&&t.resolve.length){var e=s.length;s.forEach(i(this,function(n){this._resolve(n,t.resolve,function(){!--e&&t.success(s,{cached:!0})})}))}else t.success(s,{cached:!0});else t.error(n.Error.DATABASE_ERROR,"Query is not in database.")}),r.onabort=r.onerror=function(){t.error(n.Error.DATABASE_ERROR,r.error||"Failed to execute transaction.")}}),t.error)},remove:function(e,t){t=this._options(t);var r=[this.collection];!t.silent&&r.push(h.TRANSACTION_STORE),this._transaction(r,h.READ_WRITE,i(this,function(r){var s=r.objectStore(this.collection),o=s.get(e._id);o.onsuccess=i(this,function(){var n=o.result||e;s["delete"](n._id),!t.silent&&this._addTransaction(r.objectStore(h.TRANSACTION_STORE),n)}),r.oncomplete=function(){t.success(null,{cached:!0})},r.onabort=r.onerror=function(){t.error(n.Error.DATABASE_ERROR,r.error||"Failed to execute transaction.")}}),t.error)},removeWithQuery:function(e,t){this.queryWithQuery(e,s(t,{success:i(this,function(r){var s=[this.collection,h.QUERY_STORE];!t.silent&&s.push(h.TRANSACTION_STORE),this._transaction(s,h.READ_WRITE,i(this,function(i){var s=this._getKey(e);i.objectStore(h.QUERY_STORE)["delete"](s);var o=i.objectStore(this.collection);r.forEach(function(e){o["delete"](e._id)}),!t.silent&&this._addTransaction(i.objectStore(h.TRANSACTION_STORE),r),i.oncomplete=function(){t.success(null,{cached:!0})},i.onabort=i.onerror=function(){t.error(n.Error.DATABASE_ERROR,i.error||"Failed to execute transaction.")}}),t.error)})}))},save:function(e,t){t=this._options(t);var r=[this.collection];!t.silent&&r.push(h.TRANSACTION_STORE),this._transaction(r,h.READ_WRITE,i(this,function(r){var s=r.objectStore(this.collection);e._id||(e._id=this._getRandomId());var o=s.get(e._id);o.onsuccess=i(this,function(){var n=o.result;n&&(null==e._acl&&n._acl&&(e._acl=n._acl),null==e._kmd&&n._kmd&&(e._kmd=n._kmd)),r.objectStore(this.collection).put(e),!t.silent&&this._addTransaction(r.objectStore(h.TRANSACTION_STORE),e)}),r.oncomplete=function(){t.success(e,{cached:!0})},r.onabort=r.onerror=function(){t.error(n.Error.DATABASE_ERROR,r.error||"Failed to execute transaction.")}}),t.error)},multiQuery:function(e,t){t=this._options(t),this._transaction(this.collection,h.READ_ONLY,i(this,function(r){var i={},s=r.objectStore(this.collection);e.forEach(function(e){var t=s.get(e);t.onsuccess=function(){i[e]=t.result||null}}),r.oncomplete=function(){t.success(i,{cached:!0})},r.onabort=r.onerror=function(){t.error(n.Error.DATABASE_ERROR,r.error||"Failed to execute transaction.")}}),t.error)},multiRemove:function(e,t){t=this._options(t),this._transaction(this.collection,h.READ_WRITE,i(this,function(r){var i=r.objectStore(this.collection);e.forEach(function(e){i["delete"](e)}),r.oncomplete=function(){t.success(null,{cached:!0})},r.onabort=r.onerror=function(){t.error(n.Error.DATABASE_ERROR,r.error||"Failed to execute transaction.")}}),t.error)},put:function(e,t,n,r){r=s(r,{silent:!0});switch(e){case"aggregate":this._putAggregation(t,n,r);break;case"query":null!==n?this._putSave(n,r):this.remove(t,r);break;case"queryWithQuery":null!==n?this._putQueryWithQuery(t,n,r):this.removeWithQuery(t,r)}},_putAggregation:function(e,t,r){r=this._options(r),this._transaction(h.AGGREGATION_STORE,h.READ_WRITE,i(this,function(i){var s=i.objectStore(h.AGGREGATION_STORE),o=this._getKey(e);null!==t?s.put({aggregation:o,response:t}):s["delete"](o),i.oncomplete=function(){r.success(t)},i.onabort=i.onerror=function(){r.error(n.Error.DATABASE_ERROR,i.error||"Failed to execute transaction.")}}),r.error)},_putQueryWithQuery:function(e,t,r){r=this._options(r);var o=[],u=i(this,function(){this._transaction(h.QUERY_STORE,h.READ_WRITE,i(this,function(i){i.objectStore(h.QUERY_STORE).put({query:this._getKey(e),response:o}),i.oncomplete=function(){r.success(t)},i.onabort=i.onerror=function(){r.error(n.Error.DATABASE_ERROR,i.error||"Failed to execute transaction.")}}),r.error)}),a=t.length;if(0===t.length)return u();t.forEach(i(this,function(e){this.put("query",null,e,s(r,{success:function(e){o.push(e._id),!--a&&u()},error:function(){!--a&&u()}}))}))},_putSave:function(e,t){if(t.resolve&&t.resolve.length){this._extract(e,t.resolve,i(this,function(){this.save(e,s(t,{silent:!0}))}));return}this.save(e,s(t,{silent:!0}))},getTransactions:function(e){e=this._options(e),this._transaction(h.TRANSACTION_STORE,h.READ_ONLY,i(this,function(t){var r={},s=t.objectStore(h.TRANSACTION_STORE);if(h.TRANSACTION_STORE!==this.collection){var o=s.get(this.collection);o.onsuccess=i(this,function(){var e=o.result;e&&(r[this.collection]=e.transactions)})}else{var u=s.openCursor();u.onsuccess=function(){var e=u.result;if(e){var t=e.value;r[t.collection]=t.transactions,e["continue"]()}}}t.oncomplete=function(){e.success(r)},t.onabort=t.onerror=function(){e.error(n.Error.DATABASE_ERROR,t.error||"Failed to execute transaction.")}}),e.error)},removeTransactions:function(e,t){t=this._options(t),this._transaction(h.TRANSACTION_STORE,h.READ_WRITE,i(this,function(r){var s=r.objectStore(h.TRANSACTION_STORE),o=s.get(this.collection);o.onsuccess=i(this,function(){var t=o.result;t&&(e.forEach(function(e){delete t.transactions[e]}),Object.keys(t.transactions).length?s.put(t):s["delete"](this.collection))}),r.oncomplete=function(){t.success(e,{cached:!0})},r.onabort=r.onerror=function(){t.error(n.Error.DATABASE_ERROR,r.error||"Failed to execute transaction.")}}),t.error)},_addTransaction:function(e,t){t instanceof Array||(t=[t]);var n=e.get(this.collection);n.onsuccess=i(this,function(){var r=n.result||{collection:this.collection,transactions:{}};t.forEach(function(e){r.transactions[e._id]=e._kmd?e._kmd.lmt:null}),e.put(r)})},_extract:function(e,t,n){if(0===t.length)return n();t=this._flatten(t);var r=Object.keys(t),s=r.length;r.forEach(i(this,function(r){var o=e[r];if(o instanceof Object){if("KinveyRef"===o._type)if(null!=o._obj){var u=this.collection===o._collection?this:new h(o._collection);u.put("query",null,o._obj,{resolve:t[r],success:function(){delete o._obj,!--s&&n()},error:function(){delete o._obj,!--s&&n()}})}else delete o._obj,!--s&&n();else if(o instanceof Array){var a=o.length;o.forEach(i(this,function(e,i){this._extract({_:e},t[r].concat("_"),function(){!--a&&!--s&&n()})}))}else this._extract(o,t[r],function(){!--s&&n()});return}!--s&&n()}))},_flatten:function(e){var t={};return e.forEach(function(e){var n=e.split("."),r=n.shift();t[r]||(t[r]=[]),n[0]&&t[r].push(n.join("."))}),t},_resolve:function(e,t,n){if(0===t.length)return n();t=this._flatten(t);var r=Object.keys(t),s=r.length;r.forEach(i(this,function(r){var o=e[r];if(o instanceof Object){if("KinveyRef"===o._type){var u=this.collection===o._collection?this:new h(o._collection);u.query(o._id,{resolve:t[r],success:function(e){o._obj=e,!--s&&n()},error:function(){o._obj=null,!--s&&n()}})}else if(o instanceof Array){var a=o.length;o.forEach(i(this,function(e,i){var u={x:e};this._resolve(u,t[r].concat("x"),function(){o[i]=u.x,!--a&&!--s&&n()})}))}else this._resolve(o,t[r],function(){!--s&&n()});return}!--s&&n()}))},_getRandomId:function(){return(new Date).getTime().toString()+Math.random().toString(36).substring(2,12)},_getKey:function(e){return e.collection=this.collection,JSON.stringify(e)},_getSchema:function(e){var t={};return t[h.TRANSACTION_STORE]="collection",t[h.AGGREGATION_STORE]="aggregation",t[h.QUERY_STORE]="query",{name:e,options:{keyPath:t[e]||"_id"}}},_mutate:function(e,t,n){this._open(null,null,i(this,function(r){var i=parseInt(r.version||0,10)+1;this._open(i,e,t,n)}),n)},_open:function(e,t,r,s){var o=r;r=i(this,function(e){if(h.isIdle){var t=h.queue.shift();t&&this._open.apply(this,t)}o(e)});if(null!=h.instance&&(null==e||h.instance.version===e))return r(h.instance);if(!h.isIdle)return h.queue.push(arguments);h.isIdle=!1;var u;if(h.instance&&h.instance.setVersion){u=h.instance.setVersion(e),u.onsuccess=function(){t(h.instance);var e=u.result;e.oncomplete=function(){h.isIdle=!0,r(h.instance)}},u.onblocked=u.onerror=function(){s(n.Error.DATABASE_ERROR,u.error||"Mutation error.")};return}null==e?u=l.open(this.name):u=l.open(this.name,e),u.onupgradeneeded=function(){h.instance=u.result,t&&t(h.instance)},u.onsuccess=i(this,function(){h.instance=u.result,h.instance.onversionchange=function(){h.instance&&(h.instance.close(),h.instance=null)},h.isIdle=!0,r(h.instance)}),u.onblocked=u.onerror=function(){s(n.Error.DATABASE_ERROR,"Failed to open the database.")}},_options:function(e){e||(e={});var t=e.error||function(){};return e.error=function(e,n){t({error:e,description:n||e,debug:""},{cached:!0})},e.success||(e.success=function(){}),e},_transaction:function(e,t,n,r){!(e instanceof Array)&&(e=[e]),this._open(null,null,i(this,function(s){var o=[];e.forEach(function(e){s.objectStoreNames.contains(e)||o.push(e)}),0!==o.length?this._mutate(i(this,function(e){o.forEach(i(this,function(t){if(!e.objectStoreNames.contains(t)){var n=this._getSchema(t);e.createObjectStore(n.name,n.options)}}))}),function(r){n(r.transaction(e,t))},r):n(s.transaction(e,t))}),r)}},{READ_ONLY:c.READ_ONLY||"readonly",READ_WRITE:c.READ_WRITE||"readwrite",AGGREGATION_STORE:"_aggregations",QUERY_STORE:"_queries",TRANSACTION_STORE:"_transactions",isIdle:!0,queue:[],instance:null});n.Store.Cached=r.extend({name:n.Store.CACHED,options:{policy:null,store:{},success:function(){},error:function(){},complete:function(){}},constructor:function(e,t){this.collection=e,this.db=new h(e),this.store=n.Store.factory(n.Store.APPDATA,e),this.options.policy=n.Store.Cached.NETWORK_FIRST,t&&this.configure(t)},aggregate:function(e,t){t=this._options(t),this._read("aggregate",e,t)},configure:function(e){e.policy&&(this.options.policy=e.policy),e.store&&(this.options.store=e.store),e.success&&(this.options.success=e.success),e.error&&(this.options.error=e.error),e.complete&&(this.options.complete=e.complete)},login:function(e,t){t=this._options(t),this.store.login(e,t)},logout:function(e,t){t=this._options(t),this.store.logout(e,t)},query:function(e,t){t=this._options(t),this._read("query",e,t)},queryWithQuery:function(e,t){t=this._options(t),this._read("queryWithQuery",e,t)},remove:function(e,t){t=this._options(t),this._write("remove",e,t)},removeWithQuery:function(e,t){t=this._options(t),this._write("removeWithQuery",e,t)},save:function(e,t){t=this._options(t),this._write("save",e,t)},_options:function(e){return e||(e={}),e.policy||(e.policy=this.options.policy),this.store.configure(e.store||this.options.store),e.success||(e.success=this.options.success),e.error||(e.error=this.options.error),e.complete||(e.complete=this.options.complete),e},_read:function(e,t,n){var r=this._shouldCallNetworkFirst(n.policy),o=r?this.store:this.db,u=r?this.db:this.store,a=!1,f=n.success;n.success=i(this,function(r,i){var o=a;if(!a||this._shouldCallBothCallbacks(n.policy))a=!0,f(r,i);if(i.network&&this._shouldUpdateCache(n.policy)){var u=function(){n.complete()};this.db.put(e,t,r,s(n,{success:u,error:u}))}else(o||!this._shouldCallBoth(n.policy))&&n.complete()}),o[e](t,s(n,{success:i(this,function(r,i){n.success(r,i),this._shouldCallBoth(n.policy)&&(n.error=function(){n.complete()},u[e](t,n))}),error:i(this,function(r,i){if(this._shouldCallFallback(n.policy)){var s=n.error;n.error=function(e,t){s(e,t),n.complete()},u[e](t,n)}else n.error(r,i),n.complete()})}))},_shouldCallBoth:function(e){var t=[n.Store.Cached.CACHE_FIRST,n.Store.Cached.BOTH];return-1!==t.indexOf(e)},_shouldCallBothCallbacks:function(e){return n.Store.Cached.BOTH===e},_shouldCallFallback:function(e){var t=[n.Store.Cached.NETWORK_FIRST];return this._shouldCallBoth(e)||-1!==t.indexOf(e)},_shouldCallNetworkFirst:function(e){var t=[n.Store.Cached.NO_CACHE,n.Store.Cached.NETWORK_FIRST];return-1!==t.indexOf(e)},_shouldUpdateCache:function(e){var t=[n.Store.Cached.CACHE_FIRST,n.Store.Cached.NETWORK_FIRST,n.Store.Cached.BOTH];return-1!==t.indexOf(e)},_write:function(e,t,n){var r=n.error,s=n.success;n.success=i(this,function(r,i){s(r,i);if(this._shouldUpdateCache(n.policy)){var o={remove:["query",t,null],removeWithQuery:["queryWithQuery",t,null]};"user"!==this.collection&&null!=r&&(o.save=["query",r._id,r]);if(o[e]){o[e].push({success:function(){n.complete()},error:function(){n.complete()}}),this.db.put.apply(this.db,o[e]);return}}n.complete()}),n.error=function(e,t){r(e,t),n.complete()},this.store[e](t,n)}},{NO_CACHE:"nocache",CACHE_ONLY:"cacheonly",CACHE_FIRST:"cachefirst",NETWORK_FIRST:"networkfirst",BOTH:"both"}),n.Store.Offline=n.Store.Cached.extend({name:n.Store.OFFLINE,constructor:function(e,t){if(n.Store.AppData.USER_API===e)throw new Error("The User API cannot be used with OfflineStore");n.Store.Cached.prototype.constructor.call(this,e,t)},configure:function(e){n.Store.Cached.prototype.configure.call(this,e),e.conflict&&(this.options.conflict=e.conflict)},remove:function(e,t){t=this._options(t),this.db.remove(e,this._wrap(e,t))},removeWithQuery:function(e,t){t=this._options(t),this.db.removeWithQuery(e,this._wrap(null,t))},save:function(e,t){t=this._options(t),this.db.save(e,this._wrap(e,t))},_options:function(e){return e=n.Store.Cached.prototype._options.call(this,e),n.Sync.isOnline||(e.policy=n.Store.Cached.CACHE_ONLY),e},_wrap:function(e,t){return s(t,{success:i(this,function(r){t.success(r,{offline:!0});var i={conflict:t.conflict,success:t.complete,error:t.complete};if(e)return n.Sync.object(this.collection,r||e,i);n.Sync.collection(this.collection,i)}),error:function(e){t.error(e,{offline:!0}),t.complete()}})}}),n.Sync={isOnline:navigator.onLine,options:{conflict:null,store:{},start:function(){},success:function(){},error:function(){}},configure:function(e){e.conflict&&(n.Sync.options.conflict=e.conflict),e.store&&(n.Sync.options.store=e.store),e.start&&(n.Sync.options.start=e.start),e.success&&(n.Sync.options.success=e.success),e.error&&(n.Sync.options.error=e.error)},offline:function(){n.Sync.isOnline=!1},online:function(){n.Sync.isOnline||(n.Sync.isOnline=!0,n.Sync.application())},application:function(e){e=n.Sync._options(e),n.Sync.isOnline?(new p(e)).application({start:n.Sync.options.start||function(){}}):e.error({error:n.Error.NO_NETWORK,description:"There is no active network connection.",debug:"Synchronization requires an active network connection."})},collection:function(e,t){t=n.Sync._options(t),n.Sync.isOnline?(new p(t)).collection(e):t.error({error:n.Error.NO_NETWORK,description:"There is no active network connection.",debug:"Synchronization requires an active network connection."})},object:function(e,t,r){r=n.Sync._options(r),n.Sync.isOnline?(new p(r)).object(e,t):r.error({error:n.Error.NO_NETWORK,description:"There is no active network connection.",debug:"Synchronization requires an active network connection."})},clientAlwaysWins:function(e,t,n,r){r.success(t)},ignore:function(e,t,n,r){r.error()},serverAlwaysWins:function(e,t,n,r){r.success(n)},_options:function(e){return e||(e={}),e.store||(e.store=n.Sync.options.store),e.conflict||(e.conflict=n.Sync.options.conflict||n.Sync.ignore),e.success||(e.success=n.Sync.options.success),e.error||(e.error=n.Sync.options.error),e}},window.addEventListener("online",n.Sync.online,!1),window.addEventListener("offline",n.Sync.offline,!1);var p=r.extend({constructor:function(e){this.store=e.store,this.conflict=e.conflict,this.success=e.success,this.error=e.error},application:function(e){e&&e.start&&e.start(),(new h(h.TRANSACTION_STORE)).getTransactions({success:i(this,function(e){var t={},n=Object.keys(e),r=n.length;if(0===r)return this.success(t);var s=i(this,function(e){return i(this,function(n){n&&(t[e]=n),!--r&&this.success(t)})});n.forEach(i(this,function(t){this._collection(t,e[t],s(t))}))}),error:this.error})},collection:function(e){(new h(e)).getTransactions({success:i(this,function(t){if(null==t[e])return this.success({});this._collection(e,t[e],i(this,function(t){var n={};t&&(n[e]=t),this.success(n)}))}),error:this.error})},object:function(e,t){var r=t._id,s=new h(e);s.getTransactions({success:i(this,function(t){if(null==t[e]||!t[e].hasOwnProperty(r))return this.success({});var o=t[e][r];t={},t[r]=o,this._classifyAndCommit(e,t,{db:s,objects:[r],store:n.Store.factory(n.Store.APPDATA,e,this.store)},i(this,function(t){var n={};n[e]=t,this.success(n)}))}),error:this.error})},_classify:function(e,t,n,r){this._retrieve(n.objects,n,i(this,function(s,o){var u={},a=[],f=n.objects.length,l=function(e){return{success:function(t){t&&(t._id=e),u[e]=t,!--f&&r(u,a,[])},error:function(t,n,i){a.push(e),!--f&&r(u,a,[])}}};o.forEach(i(this,function(n){var r=n._id;this._object(e,t[r],s[r],n,l(r)),delete s[r]})),Object.keys(s).forEach(i(this,function(n){this._object(e,t[n],s[n],null,l(n))}))}),function(){r([],[],n.objects)})},_classifyAndCommit:function(e,t,n,r){this._classify(e,t,n,i(this,function(e,t,i){this._commit(e,n,function(e,n){r({committed:e,conflicted:t,canceled:i.concat(n)})})}))},_collection:function(e,t,r){var i=Object.keys(t);if(0===i.length)return r();this._classifyAndCommit(e,t,{db:new h(e),objects:i,store:n.Store.factory(n.Store.APPDATA,e,this.store)},r)},_commit:function(e,t,n){t.objects=Object.keys(e);if(0===t.objects.length)return n([],[]);var r=[],i=[];t.objects.forEach(function(t){var n=e[t];null!=n?r.push(n):i.push(t)});var s=[],o=[],u=2,a=function(e,r){s=s.concat(e),o=o.concat(r);if(!--u){var i=function(){n(s,o)};t.db.removeTransactions(s,{success:i,error:i})}};this._commitUpdates(r,t,a),this._commitRemovals(i,t,a)},_commitObject:function(e,t,n){t.store.save(e,{success:function(e){var r=function(){n([e._id],[])};t.db.put("query",e._id,e,{success:r,error:r})},error:function(){n([],[e._id])}})},_commitRemovals:function(e,t,r){if(0===e.length)return r([],[]);var i=function(){var n=function(){r(e,[])};t.db.multiRemove(e,{success:n,error:n})},s=(new n.Query).on("_id").in_(e);t.store.removeWithQuery(s.toJSON(),{success:i,error:function(){r([],e)}})},_commitUpdates:function(e,t,n){if(0===e.length)return n([],[]);var r=[],s=[],o=e.length,u=function(e,t){r=r.concat(e),s=s.concat(t),!--o&&n(r,s)};e.forEach(i(this,function(e){this._commitObject(e,t,u)}))},_object:function(e,t,n,r,i){if(null===r||t===r._kmd.lmt)return i.success(n);this.conflict(e,n,r,{success:i.success,error:function(){i.error(e,n,r)}})},_retrieve:function(e,t,r,i){var s=[],o=[],u=2,a=function(){return{success:function(e,t){t.network?o=e:s=e,!--u&&r(s,o)},error:function(){i(),i=function(){}}}},f=(new n.Query).on("_id").in_(e);t.store.queryWithQuery(f.toJSON(),a()),t.db.multiQuery(e,a())}})}).call(this);